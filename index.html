<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="150x150" href="/images/favicon-150x150-next.png">
  <link rel="icon" type="image/png" sizes="150x150" href="/images/favicon-150x150-next.png">
  <link rel="icon" type="image/png" sizes="150x150" href="/images/favicon-150x150-next.png">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lwenkun.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"order":-2}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Chance 的博客">
<meta property="og:url" content="https://lwenkun.github.io/index.html">
<meta property="og:site_name" content="Chance 的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chance">
<meta property="article:tag" content="Chance, 安卓, android, java, Chance&#39;s blog, Chance 的博客">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://lwenkun.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Chance 的博客</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76493784-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-76493784-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4cc1f2d8f3067386cc5cdb626a202900";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Chance 的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">吾生也有涯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">26</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">27</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/" class="post-title-link" itemprop="url">探究 Kotlin 协程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-08 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-08T00:00:00+00:00">2024-04-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>23 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Kotlin 中的协程是无栈协程（话说 Kotlin 能实现有栈线程吗🤔），网上很多文章都说无栈协程一般都是通过状态机实现的，刚开始听到这个状态机的时候觉得有点玄乎，今天打算利用反编译工具并结合协程库源码，来探究一下 kotlin 协程实现原理。</p>
<h1 id="从一个简单的示例开始"><a href="#从一个简单的示例开始" class="headerlink" title="从一个简单的示例开始"></a>从一个简单的示例开始</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    runBlocking &#123;</span><br><span class="line">        <span class="keyword">val</span> result = fun1()</span><br><span class="line">        println(result)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> localInt = <span class="number">0</span></span><br><span class="line">    localInt += fun2()</span><br><span class="line">    localInt += fun3()</span><br><span class="line">    <span class="keyword">return</span> localInt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun2</span><span class="params">()</span></span>: <span class="built_in">Int</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun3</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<!-- more  -->

<p>以上代码通过 <code>runBlocking()</code>​ 开启协程，协程调用 <code>fun1()</code>​ ，然后打印结果。<code>fun1()</code>​ 是一个 <code>suspend</code>​ 方法，它定义了一个局部变量 <code>localInt</code>​，然后依次执行了 <code>fun2()</code>​ 和 <code>fun3()</code>​ 并将二者结果累加到 <code>localInt</code>​ 中，最后将 <code>localInt</code>​ 返回。<code>fun2()</code>​ 是一个普通方法,<code>fun3()</code>​ 内调用了 <code>delay()</code>​，<code>delay()</code>​ 是协程库提供的 <code>suspend</code>​方法。</p>
<p>下面我们将会从 <code>runBlocking()</code>​ 开始，揭开 Kotlin 协程的神秘面纱。</p>
<h2 id="Builders-runBlocking"><a href="#Builders-runBlocking" class="headerlink" title="Builders#runBlocking"></a>Builders#runBlocking</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">runBlocking</span><span class="params">(context: <span class="type">CoroutineContext</span>, block: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.() -&gt; <span class="type">T</span>)</span></span>: T &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> currentThread = Thread.currentThread()</span><br><span class="line">    <span class="keyword">val</span> contextInterceptor = context[ContinuationInterceptor]</span><br><span class="line">    <span class="keyword">val</span> eventLoop: EventLoop?</span><br><span class="line">    <span class="keyword">val</span> newContext: CoroutineContext</span><br><span class="line">    <span class="keyword">if</span> (contextInterceptor == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// create or use private event loop if no dispatcher is specified</span></span><br><span class="line">        eventLoop = ThreadLocalEventLoop.eventLoop</span><br><span class="line">        newContext = GlobalScope.newCoroutineContext(context + eventLoop)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// See if context&#x27;s interceptor is an event loop that we shall use (to support TestContext)</span></span><br><span class="line">        <span class="comment">// or take an existing thread-local event loop if present to avoid blocking it (but don&#x27;t create one)</span></span><br><span class="line">        eventLoop = (contextInterceptor <span class="keyword">as</span>? EventLoop)?.takeIf &#123; it.shouldBeProcessedFromContext() &#125;</span><br><span class="line">            ?: ThreadLocalEventLoop.currentOrNull()</span><br><span class="line">        newContext = GlobalScope.newCoroutineContext(context)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> coroutine = BlockingCoroutine&lt;T&gt;(newContext, currentThread, eventLoop)</span><br><span class="line">    coroutine.start(CoroutineStart.DEFAULT, coroutine, block)</span><br><span class="line">    <span class="keyword">return</span> coroutine.joinBlocking()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的逻辑非常清晰：</p>
<ul>
<li>5 ~ 19 行用来构建协程的上下文，协程上下文是一些元素的集合，包括拦截器，代表协程的任务，异常处理器，协程名称等。</li>
<li>20 行 <code>BlockingCoroutine&lt;T&gt;(newContext, currentThread, eventLoop)</code>​构建协程对象</li>
<li>21 行 <code>coroutine#start()</code>​ 启动协程</li>
<li>22 行阻塞当前线程，直到协程结束。</li>
</ul>
<p>只要搞懂了 <code>BlockingCotoutine</code>​ 和 <code>coroutine#start()</code>​，就能对 kotlin 协程的实现原理有一个大致的了解。为了便于理解，我们先从  <code>Coroutine#Start()</code>​ 着手。</p>
<h2 id="Coroutine-Start"><a href="#Coroutine-Start" class="headerlink" title="Coroutine#Start"></a>Coroutine#Start</h2><p>省略一些中间过程，<code>Coroutine#Start</code>​ 最后会调用到下面这个方法：</p>
<h3 id="CoroutineStarter-invoke"><a href="#CoroutineStarter-invoke" class="headerlink" title="CoroutineStarter#invoke"></a>CoroutineStarter#invoke</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="title">invoke</span><span class="params">(block: <span class="type">suspend</span> <span class="type">R</span>.() -&gt; <span class="type">T</span>, receiver: <span class="type">R</span>, completion: <span class="type">Continuation</span>&lt;<span class="type">T</span>&gt;)</span></span>: <span class="built_in">Unit</span> =</span><br><span class="line">        <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            DEFAULT -&gt; block.startCoroutineCancellable(receiver, completion)</span><br><span class="line">            ATOMIC -&gt; block.startCoroutine(receiver, completion)</span><br><span class="line">            UNDISPATCHED -&gt; block.startCoroutineUndispatched(receiver, completion)</span><br><span class="line">            LAZY -&gt; <span class="built_in">Unit</span> <span class="comment">// will start lazily</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>协程有多种启动模式，简单起见，我们只研究 <code>DEFAULT</code>​ 模式，其他分支原理大同小异。<code>block.startCoroutineCancellable()</code>​ 源码如下：</p>
<h3 id="Cancellable-startCoroutineCancellable"><a href="#Cancellable-startCoroutineCancellable" class="headerlink" title="Cancellable#startCoroutineCancellable"></a>Cancellable#startCoroutineCancellable</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Use this function to start coroutine in a cancellable way, so that it can be cancelled</span></span><br><span class="line"><span class="comment"> * while waiting to be dispatched.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> (R)</span></span> -&gt; T).startCoroutineCancellable(</span><br><span class="line">    receiver: R, completion: Continuation&lt;T&gt;,</span><br><span class="line">    onCancellation: ((cause: Throwable) -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line">) =</span><br><span class="line">    runSafely(completion) &#123;</span><br><span class="line">        createCoroutineUnintercepted(receiver, completion).intercepted().resumeCancellableWith(Result.success(<span class="built_in">Unit</span>), onCancellation)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重点是 <code>createCoroutineUnintercepted()</code>​：</p>
<h3 id="IntrinsicsJvm-createCoroutineUnintercepted"><a href="#IntrinsicsJvm-createCoroutineUnintercepted" class="headerlink" title="IntrinsicsJvm#createCoroutineUnintercepted"></a>IntrinsicsJvm#createCoroutineUnintercepted</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.3&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> R.()</span></span> -&gt; T).createCoroutineUnintercepted(</span><br><span class="line">    receiver: R,</span><br><span class="line">    completion: Continuation&lt;T&gt;</span><br><span class="line">): Continuation&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> probeCompletion = probeCoroutineCreated(completion)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> BaseContinuationImpl)</span><br><span class="line">        create(receiver, probeCompletion)</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        createCoroutineFromSuspendFunction(probeCompletion) &#123;</span><br><span class="line">            (<span class="keyword">this</span> <span class="keyword">as</span> Function2&lt;R, Continuation&lt;T&gt;, Any?&gt;).invoke(receiver, it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般来说代码会走到 if 分支。if 分支调用了 suspend block 的 <code>create()</code>​ 方法。这个方法是编译器为 suspend lambda 生成的。接下来我们需要反编译示例代码来进一步探究。</p>
<p class="notice-info">反编译 Kotlin 代码是没法使用传统的反编译工具来完成的，需要在 IDEA 中打开 Kotlin 字节码文件，然后点击 工具 -> Kotlin -> 反编译为  Java 来完成。</p>

<h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><p>先看 <code>main</code>​ 方法的反编译结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">      BuildersKt.runBlocking$<span class="keyword">default</span>((CoroutineContext)<span class="literal">null</span>, (Function2)(<span class="keyword">new</span> <span class="title class_">Function2</span>((Continuation)<span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="type">int</span> label;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(<span class="meta">@NotNull</span> Object $result)</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> IntrinsicsKt.getCOROUTINE_SUSPENDED();</span><br><span class="line">            Object var10000;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">this</span>.label) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  <span class="type">Continuation</span> <span class="variable">var4</span> <span class="operator">=</span> (Continuation)<span class="built_in">this</span>;</span><br><span class="line">                  <span class="built_in">this</span>.label = <span class="number">1</span>;</span><br><span class="line">                  var10000 = TestKt.fun1(var4);          <span class="comment">// fun1()</span></span><br><span class="line">                  <span class="keyword">if</span> (var10000 == var3) &#123;</span><br><span class="line">                     <span class="keyword">return</span> var3;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  var10000 = $result;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ((Number)var10000).intValue();</span><br><span class="line">            System.out.println(result);</span><br><span class="line">            <span class="keyword">return</span> Unit.INSTANCE;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@NotNull</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Continuation <span class="title function_">create</span><span class="params">(<span class="meta">@Nullable</span> Object value, <span class="meta">@NotNull</span> Continuation $completion)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Continuation)(<span class="keyword">new</span> &lt;anonymous constructor&gt;($completion));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> CoroutineScope p1, <span class="meta">@Nullable</span> Continuation p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((&lt;undefinedtype&gt;)<span class="built_in">this</span>.create(p1, p2)).invokeSuspend(Unit.INSTANCE);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object p1, Object p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.invoke((CoroutineScope)p1, (Continuation)p2);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;), <span class="number">1</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>​<code>runBlocking$default()</code>​ 是 <code>runBlocking()</code>​ 的反编译后的名字。反编译后的代码中，它接收四个参数，后面两个参数暂时不用理会。第一个参数类型为 <code>CoroutineContext</code>​，传入的是 <code>null</code>​。第二个参数是一个 <code>Function2</code>​ 对象，<code>Function2</code>​ 是 Kotlin 库中的一个接口，定义如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Function2</span>&lt;<span class="type">in P1, in P2, out R</span>&gt; : <span class="type">Function</span>&lt;<span class="type">R</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(p1: <span class="type">P1</span>, p2: <span class="type">P2</span>)</span></span>: R</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Kotlin 编译器用 <code>Function1</code>​，<code>Function2</code>​ … <code>FuncitonX</code>​  接口来实现 lambda 表达式，Function 后面的数字表示 lambda 参数的数量。如果 lambda 有 receiver，receiver 会被视为其第一个参数，对应的 <code>invoke()</code>​ 的第一个参数为 receiver，后续参数为  lambda 的实际参数。例如，lambda 表达式  <code>val a: Int.(Int, Int) -&gt; Int = &#123; x: Int, y: Int -&gt; this + x + y &#125;</code>​ 会用以下代码来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Function3</span> <span class="variable">a</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Function3</span>&lt;Integer, Integer, Integer, Object&gt; &#123;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(Integer p1, Integer p2, Integer p3)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> p1 + p2 + p3;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 suspend lambda，实现则略有不同，例如对于一个空的 lambda： <code>val a: suspend () -&gt; &#123;&#125; = &#123;&#125;</code>​，实际上生成的对象大概是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_SuspendLambda</span> <span class="keyword">extends</span> <span class="title class_">SuspendLambda</span> <span class="keyword">implements</span> <span class="title class_">Function1</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(Object result)</span> &#123;</span><br><span class="line">		 <span class="comment">/* lambda 函数体逻辑，省略 */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">_SuspendLambda</span><span class="params">(Continuation completion)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(<span class="number">0</span> <span class="comment">/* 这个值具体是多少不知道，也不重要，我这里是乱写的 */</span>, completion):</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(Continuation completion)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.create(completion).invokeSuspend(completion)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object p1)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invoke((Continuation)p2);</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Continuation <span class="title function_">create</span><span class="params">(completion: Continuation)</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> AnnoymousClass(completion));</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kotlin 会为每一个 suspend lambda 生成一个继承 <code>SuspendLambda</code>​ 并实现 <code>FunctionX</code>​ 接口的匿名类，这里我用 <code>_SuspendLambda</code>​表示，并且还给它添加了一个 <code>Cotinuation</code>​ 类型的参数，这个参数具体什么含义，我们后面会讲。此外，还会为它额外生成 <code>invokeSuspend()</code>​ ，<code>create()</code>​ 和 <code>invoke()</code>​ 这三个函数。<code>invokeSuspend()</code>​ 代表 lambda 函数体的逻辑，<code>create()</code>​ 用来创建自身的一个新的实例，<code>invoke()</code>​ 重载方法貌似有点多余，只是对参数类型具体化了一下而已。</p>
<p>我们现在回过头来看 <code>runBlocking$default()</code>​ 的第二个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Function2</span>((Continuation)<span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="type">int</span> label;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(<span class="meta">@NotNull</span> Object $result)</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> IntrinsicsKt.getCOROUTINE_SUSPENDED();</span><br><span class="line">            Object var10000;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">this</span>.label) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  <span class="type">Continuation</span> <span class="variable">var4</span> <span class="operator">=</span> (Continuation)<span class="built_in">this</span>;</span><br><span class="line">                  <span class="built_in">this</span>.label = <span class="number">1</span>;</span><br><span class="line">                  var10000 = TestKt.fun1(var4);          <span class="comment">// fun1()</span></span><br><span class="line">                  <span class="keyword">if</span> (var10000 == var3) &#123;</span><br><span class="line">                     <span class="keyword">return</span> var3;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  var10000 = $result;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ((Number)var10000).intValue();</span><br><span class="line">            System.out.println(result);</span><br><span class="line">            <span class="keyword">return</span> Unit.INSTANCE;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@NotNull</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Continuation <span class="title function_">create</span><span class="params">(<span class="meta">@Nullable</span> Object value, <span class="meta">@NotNull</span> Continuation $completion)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Continuation)(<span class="keyword">new</span> &lt;anonymous constructor&gt;($completion));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> CoroutineScope p1, <span class="meta">@Nullable</span> Continuation p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((&lt;undefinedtype&gt;)<span class="built_in">this</span>.create(p1, p2)).invokeSuspend(Unit.INSTANCE);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object p1, Object p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.invoke((CoroutineScope)p1, (Continuation)p2);</span><br><span class="line">         &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这就是 <code>runBlocking()</code>​ 的 suspend lambda 参数编译后的样子 。细心的你会发现不一样的地方，就是 <code>invoke()</code>​ 多了一个类型为 <code>CoroutineScope</code>​ 的参数。这是因为 <code>runBlocking()</code>​ 的 suspend lambda 参数有 receiver，前面讲过，如果 lambda 有 receiver， receiver 会被视为 lambda 的第一个参数。</p>
<p>现在回过头看看 <code>createCoroutineUnintercepted</code>​：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SinceKotlin(&quot;1.3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> actual fun &lt;R, T&gt; (suspend R.() -&gt; T).createCoroutineUnintercepted(</span><br><span class="line">    receiver: R,</span><br><span class="line">    completion: Continuation&lt;T&gt;</span><br><span class="line">): Continuation&lt;Unit&gt; &#123;</span><br><span class="line">    <span class="type">val</span> <span class="variable">probeCompletion</span> <span class="operator">=</span> probeCoroutineCreated(completion)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (<span class="built_in">this</span> is BaseContinuationImpl)</span><br><span class="line">        create(receiver, probeCompletion)</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        createCoroutineFromSuspendFunction(probeCompletion) &#123;</span><br><span class="line">            (<span class="built_in">this</span> as Function2&lt;R, Continuation&lt;T&gt;, Any?&gt;).invoke(receiver, it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>this</code>​ 就是 suspend lambda，它是一个 <code>SuspendLambda</code>​ 的一个实例，<code>SuspendLambda</code>​ 的继承链是：<code>SuspendLambda</code>​ -&gt; <code>ContinuationImpl</code>​ -&gt; <code>BaseContinuationImpl</code>​ -&gt; <code>Continuation</code>​，因此，代码会走到 <code>if</code>​ 分支。<code>if</code>​ 分支很简单，就是调用 suspend lambda 的 <code>create()</code>​ 方法，这个方法正是前面编译器为 suspend lambda 生成的方法。什么情况下会走到 <code>else</code>​ 分支我目前还不清楚，但大概能猜到它的逻辑是： 当编译器为 suspend lambda 生成的对象实现了 <code>Function2</code>​ 接口但没有继承 <code>BaseContinuationImpl</code>​的时候，就将其包装成 <code>Continuation</code>​再返回。</p>
<p>往前看 <code>startCoroutineCancellable()</code>​：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> (R)</span></span> -&gt; T).startCoroutineCancellable(</span><br><span class="line">    receiver: R, completion: Continuation&lt;T&gt;,</span><br><span class="line">    onCancellation: ((cause: Throwable) -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line">) =</span><br><span class="line">    runSafely(completion) &#123;</span><br><span class="line">        createCoroutineUnintercepted(receiver, completion).intercepted().resumeCancellableWith(Result.success(<span class="built_in">Unit</span>), onCancellation)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​<code>intercepted()</code>​ 是 kotlin 用来实现上下文切换的，这个我们先不管，因为我们的示例并未涉及协程的上下文切换，可以认为这个方法不包含任何逻辑，只是简单地返回对象本身。重点是 <code>resumeCancellableWith()</code>​ ：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Continuation<span class="type">&lt;T&gt;</span>.<span class="title">resumeCancellableWith</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    onCancellation: ((<span class="type">cause</span>: <span class="type">Throwable</span>) -&gt; <span class="type">Unit</span>)? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Unit</span> = <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">is</span> DispatchedContinuation -&gt; resumeCancellableWith(result, onCancellation)</span><br><span class="line">    <span class="keyword">else</span> -&gt; resumeWith(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>涉及上下文切换时才会走到 <code>is DispatchedContinuation</code>​分支，因此我们的代码会走 <code>else</code>​ 分支，<code>else</code>​ 分支调用的是 <code>Continuation</code>​ 的 <code>resumeWith()</code>​ 方法，这个方法在 <code>Continuation</code>​ 接口定义：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Continuation</span>&lt;<span class="type">in T</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The context of the coroutine that corresponds to this continuation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> context: CoroutineContext</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resumes the execution of the corresponding coroutine passing a successful or failed [result] as the</span></span><br><span class="line"><span class="comment">     * return value of the last suspension point.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再继续探索之前，我们先得了解一下协程中的 <code>Continuation</code>​是什么东西。看下维基百科对协程的定义：</p>
<blockquote>
<p><strong>协程</strong>（英语：coroutine）是计算机程序的一类组件，推广了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%A4%9A%E4%BB%BB%E5%8A%A1" title="协作式多任务">协作式多任务</a>的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%90%E4%BE%8B%E7%A8%8B" title="子例程">子例程</a>，允许执行被挂起与被恢复</p>
</blockquote>
<p>​<code>Continuation</code>​ 正是 kotlin 用来实现协程 <strong>允许执行被挂起与被恢复</strong> 这一语义的。<code>Continuation</code>​ 逻辑上是一个栈式结构，它用来模拟 suspend 方法（包括 suspend lambda）的调用栈，为什么需要模拟 suspend 方法的调用栈？我们知道，非 suspend 方法的调用栈是由虚拟机维护的，也就是我们所熟悉的栈帧，但是虚拟机并不会为 suspend 方法生成栈帧，这是因为 suspend 方法的调用和返回都是异步的，虚拟机的世界中，并没有异步方法调用的概念，它属于 kotlin 语言自己的语义范畴，Kotlin 编译器必须自己负责实现这个语义。Kotlin 实现这个语义的方案是，为每一个 suspend 方法生成一个对应的 <code>Continuation</code>​ 对象，由这个对象负责保存 suspend 方法的上下文。逻辑上它会把一个 suspend 方法分割成多段，每当调用另一个 suspend 方法时，当前 suspend 方法便会被挂起（暂停执行），相应的<code>Continuation</code>​会保存其上下文，后续可调用其 <code>resumeWith</code>​ 方法（通常由下游 suspend 方法的 <code>Continuation</code>​ 对象调用）恢复 suspend 方法的上下文，让它从挂起点接着执行，就这样直到当前 suspend 方法执行完毕。当前 suspend 方法完成之后，会调用调用栈上游的 suspend 方法所<code>Continuation</code>​对象的 <code>resumeWith</code>​方法，从而让上游的 suspend 方法接着执行，上游方法重复这个过程，直到最顶层的 suspend 方法执行完毕。</p>
<p>现在听上去可能会有点抽象，后面看具体实现就明白了。</p>
<p>​<code>resumeWith()</code>​ 是 <code>Continiuation</code>​ 接口的唯一方法，该方法在子类 <code>BaseContinuationImpl</code>​ 中有个 <code>final</code>​ 实现：</p>
<h3 id="BaseContinuationImpl"><a href="#BaseContinuationImpl" class="headerlink" title="BaseContinuationImpl"></a>BaseContinuationImpl</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseContinuationImpl</span>(</span><br><span class="line">    <span class="comment">// This is `public val` so that it is private on JVM and cannot be modified by untrusted code, yet</span></span><br><span class="line">    <span class="comment">// it has a public getter (since even untrusted code is allowed to inspect its call stack).</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> completion: Continuation&lt;Any?&gt;?</span><br><span class="line">) : Continuation&lt;Any?&gt;, CoroutineStackFrame, Serializable &#123;</span><br><span class="line">    <span class="comment">// This implementation is final. This fact is used to unroll resumeWith recursion.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">        <span class="comment">// This loop unrolls recursion in current.resumeWith(param) to make saner and shorter stack traces on resume</span></span><br><span class="line">        <span class="keyword">var</span> current = <span class="keyword">this</span></span><br><span class="line">        <span class="keyword">var</span> param = result</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// Invoke &quot;resume&quot; debug probe on every resumed continuation, so that a debugging library infrastructure</span></span><br><span class="line">            <span class="comment">// can precisely track what part of suspended callstack was already resumed</span></span><br><span class="line">            probeCoroutineResumed(current)</span><br><span class="line">            with(current) &#123;</span><br><span class="line">                <span class="keyword">val</span> completion = completion!! <span class="comment">// fail fast when trying to resume continuation without completion</span></span><br><span class="line">                <span class="keyword">val</span> outcome: Result&lt;Any?&gt; =</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">val</span> outcome = invokeSuspend(param)</span><br><span class="line">                        <span class="keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="keyword">return</span></span><br><span class="line">                        Result.success(outcome)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (exception: Throwable) &#123;</span><br><span class="line">                        Result.failure(exception)</span><br><span class="line">                    &#125;</span><br><span class="line">                releaseIntercepted() <span class="comment">// this state machine instance is terminating</span></span><br><span class="line">                <span class="keyword">if</span> (completion <span class="keyword">is</span> BaseContinuationImpl) &#123;</span><br><span class="line">                    <span class="comment">// unrolling recursion via loop</span></span><br><span class="line">                    current = completion</span><br><span class="line">                    param = outcome</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// top-level completion reached -- invoke and return</span></span><br><span class="line">                    completion.resumeWith(outcome)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any?</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这其实是一个用循环展开尾递归的的例子，避免因过深的调用栈造成栈溢出，同时生成更简洁的调用栈信息。为了便于理解，用递归简化一下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">    probeCoroutineResumed(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">val</span> completion = completion ?: error(<span class="string">&quot;Completion should not be null&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> outcome: Result&lt;Any?&gt; = <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> outcome = invokeSuspend(result)</span><br><span class="line">        <span class="keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="keyword">return</span></span><br><span class="line">        Result.success(outcome)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">        Result.failure(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    releaseIntercepted()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completion <span class="keyword">is</span> BaseContinuationImpl) &#123;</span><br><span class="line">        <span class="comment">// 递归调用上游 Continuation</span></span><br><span class="line">        completion.resumeWith(outcome)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 调用到最顶层 Continuation</span></span><br><span class="line">        completion.resumeWith(outcome)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>invokeSuspend</code>​执行的是 suspend 方法体中的逻辑，前面提到过，这个方法是编译器为 <code>_SuspendLambda</code>​ 生成的。如果此次返回的是 <code>COROUTINE_SUSPENDED</code>​，则会导致<code>resumeWith</code>​ 方法返回，这代表着该<code>Continuation</code>​对应的 suspend 方法挂起。否则说明 suspend 方法执行完毕，接着会递归调用上游 suspend 方法的 <code>Continuation</code>​ 对象的 <code>resumeWith</code>​ 方法。Kotlin 将上游 suspend 方法的 <code>Continuation</code>​ 对象命名为 <code>completion</code>​ ，可以说是非常贴切了，可以把上游 <code>Continuation</code>​ 对象等价地理解为当前 suspend 方法结束后需要执行的动作。</p>
<p>我们回顾一下这个方法，为便于理解我将其还原为 kotlin 并简化：</p>
<h3 id="SuspendLambda"><a href="#SuspendLambda" class="headerlink" title="_SuspendLambda"></a>_SuspendLambda</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_SuspendLambda</span> : <span class="type">SuspendLambda</span>, <span class="type">Function1</span>&lt;<span class="type">Object</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">val</span> label = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Object</span>)</span></span>: Object &#123;</span><br><span class="line">		<span class="keyword">var</span> fun1Result: Object?</span><br><span class="line">        <span class="keyword">when</span> (<span class="keyword">this</span>.label) &#123;</span><br><span class="line">            <span class="number">0</span> -&gt; &#123;</span><br><span class="line">                Result.throwOnFailure(result)</span><br><span class="line">                <span class="keyword">this</span>.label = <span class="number">1</span></span><br><span class="line">                fun1Result = fun1(<span class="keyword">this</span> <span class="keyword">as</span> Continuation)         <span class="comment">// fun1()</span></span><br><span class="line">                <span class="keyword">if</span> (fun1Result == COROUTINE_SUSPENDED) &#123;</span><br><span class="line">                    <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="number">1</span> -&gt; &#123;</span><br><span class="line">                Result.throwOnFailure(result)</span><br><span class="line">                fun1Result = result</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> -&gt;</span><br><span class="line">                <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> finalResult = fun1Result <span class="keyword">as</span> <span class="built_in">Int</span></span><br><span class="line">        println(finalResult)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Unit</span>.INSTANCE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">_SuspendLambda</span><span class="params">(Continuation completion)</span></span> &#123;</span><br><span class="line">		<span class="keyword">super</span>(<span class="number">0</span> <span class="comment">/* 这个值具体是多少不知道，也不重要，我这里是乱写的 */</span>, completion):</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(completion: <span class="type">Continuation</span>)</span></span>: Object &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.create(completion).invokeSuspend(completion)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(Object p1)</span></span>: Object &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.invoke((Continuation)p2)</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(completion: <span class="type">Continuation</span>)</span></span>: Continuation &#123;</span><br><span class="line">         <span class="keyword">return</span> AnnoymousClass(completion))</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是 <code>Continuation</code>​ 将 suspend 方法分割成多段的具体实现。在我们的例子中，kotlin 编译器将 suspend lambda 分割成了两段，一段是调用 <code>fun1()</code>​ 获取结果，另一段是打印结果。每一段逻辑用 <code>label</code>​ 对进行标记，第一次调用<code>_SuspendLambda</code>​的 <code>resumeWith()</code>​ 方法时，<code>label</code>​ 为 <code>0</code>​，会走到 <code>0 -&gt; </code>​这个分支。这个分支的逻辑如下：</p>
<ul>
<li>将 <code>label</code>​ 置位 1，这样下次就会从 <code>1 -&gt;</code>​这个分支执行。</li>
<li>调用 <code>fun1()</code>​ 获取结果，因为<code>fun1() </code>​返回的是 <code>COROUTINE_SUSPENDED</code>​ （因为 <code>fun1()</code>​ 是 suspend 方法，所以此处返回的就是 <code>COROUTINE_SUSPENDED</code>​，原因后面分析 <code>fun1()</code>​ 的时候就知道了）， 所以<code>invokeSuspend()</code>​ 会从第 10 行返回，<code>resumeWith()</code>​拿到这个结果后，suspend lambda 的执行则会终止。</li>
</ul>
<p>你可能会有疑问，示例代码中的<code>fun1()</code>​ 没有参数，为什么这里会传参数？前面说过，当一个 suspend 方法执行完毕后，它会调用上游 suspend 方法所对应的 <code>Continuation</code>​ 对象的 <code>resumeWith()</code>​ 方法来恢复上游方法的执行，因此下游方法必须拿到上游方法的 <code>Continuation</code>​ 对象才行。和 suspend lambda 一样，Kotlin 也会为每一个 suspend 方法自动添加一个 <code>Continuation</code>​ 类型的参数，目的就是为了让下游方法持有上游方法的 <code>Continuation</code>​ 对象。</p>
<p class="notice-success">实际上这个参数有多重含义，这个后面会说</p>

<p>现在来看看 <code>fun1()</code>​ 的逻辑，其反编译结果如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> static <span class="keyword">final</span> Object fun1(<span class="meta">@NotNull</span> Continuation var0) &#123;</span><br><span class="line">   Object $continuation;</span><br><span class="line">   label27: &#123;</span><br><span class="line">      <span class="keyword">if</span> (var0 instanceof &lt;undefinedtype&gt;) &#123;</span><br><span class="line">         $continuation = (&lt;undefinedtype&gt;)var0;</span><br><span class="line">         <span class="keyword">if</span> ((((&lt;undefinedtype&gt;)$continuation).label &amp; Integer.MIN_VALUE) != <span class="number">0</span>) &#123;</span><br><span class="line">            ((&lt;undefinedtype&gt;)$continuation).label -= Integer.MIN_VALUE;</span><br><span class="line">            <span class="keyword">break</span> label27;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $continuation = new ContinuationImpl(var0) &#123;</span><br><span class="line">         int I$<span class="number">0</span>;</span><br><span class="line">         <span class="comment">// $FF: synthetic field</span></span><br><span class="line">         Object result;</span><br><span class="line">         int label;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object invokeSuspend(<span class="meta">@NotNull</span> Object $result) &#123;</span><br><span class="line">            <span class="keyword">this</span>.result = $result;</span><br><span class="line">            <span class="keyword">this</span>.label |= Integer.MIN_VALUE;</span><br><span class="line">            <span class="keyword">return</span> TestKt.fun1((Continuation)<span class="keyword">this</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Object var10000;</span><br><span class="line">   int localInt;</span><br><span class="line">   int var2;</span><br><span class="line">   Object var3;</span><br><span class="line">   label22: &#123;</span><br><span class="line">      Object $result = ((&lt;undefinedtype&gt;)$continuation).result;</span><br><span class="line">      Object var6 = IntrinsicsKt.getCOROUTINE_SUSPENDED();</span><br><span class="line">      switch (((&lt;undefinedtype&gt;)$continuation).label) &#123;</span><br><span class="line">         case <span class="number">0</span>:</span><br><span class="line">            ResultKt.throwOnFailure($result);</span><br><span class="line">            localInt = <span class="number">0</span>;</span><br><span class="line">            var2 = localInt;</span><br><span class="line">            ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span> = localInt;</span><br><span class="line">            ((&lt;undefinedtype&gt;)$continuation).label = <span class="number">1</span>;</span><br><span class="line">            var10000 = fun2((Continuation)$continuation);</span><br><span class="line">            <span class="keyword">if</span> (var10000 == var6) &#123;</span><br><span class="line">               <span class="keyword">return</span> var6;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         case <span class="number">1</span>:</span><br><span class="line">            var2 = ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span>;</span><br><span class="line">            ResultKt.throwOnFailure($result);</span><br><span class="line">            var10000 = $result;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         case <span class="number">2</span>:</span><br><span class="line">            var2 = ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span>;</span><br><span class="line">            ResultKt.throwOnFailure($result);</span><br><span class="line">            var10000 = $result;</span><br><span class="line">            <span class="keyword">break</span> label22;</span><br><span class="line">         default:</span><br><span class="line">            <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var3 = var10000;</span><br><span class="line">      localInt = var2 + ((Number)var3).intValue();</span><br><span class="line">      var2 = localInt;</span><br><span class="line">      ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span> = localInt;</span><br><span class="line">      ((&lt;undefinedtype&gt;)$continuation).label = <span class="number">2</span>;</span><br><span class="line">      var10000 = fun3((Continuation)$continuation);</span><br><span class="line">      <span class="keyword">if</span> (var10000 == var6) &#123;</span><br><span class="line">         <span class="keyword">return</span> var6;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   var3 = var10000;</span><br><span class="line">   localInt = var2 + ((Number)var3).intValue();</span><br><span class="line">   <span class="keyword">return</span> Boxing.boxInt(localInt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了便于理解同样改写成 kotlin 代码。代码太多，我使用了 ChatGPT 来辅助完成：</p>
<h3 id="fun1"><a href="#fun1" class="headerlink" title="fun1"></a>fun1</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Fun1Continuation</span>(</span><br><span class="line">    <span class="keyword">val</span> completion: Continuation&lt;Any?&gt;</span><br><span class="line">) : ContinuationImpl&lt;Any?&gt;(completion) &#123;</span><br><span class="line">    <span class="keyword">var</span> label = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> result: Any? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> I$<span class="number">0</span>: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.result = result.getOrNull()</span><br><span class="line">        <span class="keyword">this</span>.label = <span class="keyword">this</span>.label or <span class="number">0x80000000</span></span><br><span class="line">        <span class="keyword">return</span> fun1(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">(continuation: <span class="type">Continuation</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any? &#123;</span><br><span class="line">    <span class="comment">// 如果 continuation 是之前包装过的，直接使用；否则将 continuation 包装成一个 Fun1Continuation，将其作为上游 Continuation 持有</span></span><br><span class="line">    <span class="keyword">val</span> cont = <span class="keyword">if</span> (continuation <span class="keyword">is</span> Fun1Continuation) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((continuation.label and <span class="number">0x80000000</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            continuation.label = continuation.label and <span class="number">0x7fffffff</span></span><br><span class="line">            continuation</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Fun1Continuation(continuation)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Fun1Continuation(continuation)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = cont.result</span><br><span class="line"></span><br><span class="line">    run <span class="symbol">handleAfterFun3@</span>&#123;</span><br><span class="line">        run <span class="symbol">handleAfterFun2@</span>&#123;</span><br><span class="line">            <span class="keyword">when</span> (cont.label) &#123;</span><br><span class="line">                <span class="number">0</span> -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 初始状态</span></span><br><span class="line">                    Result.throwOnFailure(result)</span><br><span class="line">                    <span class="keyword">val</span> localInt = <span class="number">0</span></span><br><span class="line">                    cont.I$<span class="number">0</span> = localInt</span><br><span class="line">                    cont.label = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">val</span> res = fun2(cont)</span><br><span class="line">                    <span class="keyword">if</span> (res === COROUTINE_SUSPENDED) <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">                    result = res</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="number">1</span> -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 如果 fun2 是异步，那么从 fun2 恢复时会进入到这个分支</span></span><br><span class="line">                    Result.throwOnFailure(result)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@handleAfterFun2</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="number">2</span> -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 如果 fun3 是异步，那么从 fun3 恢复时会进入到这个分支</span></span><br><span class="line">                    Result.throwOnFailure(result)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@handleAfterFun3</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// fun2 执行完毕后的逻辑，无论同步异步都会走到这</span></span><br><span class="line">        <span class="keyword">val</span> localInt = cont.I$<span class="number">0</span></span><br><span class="line">        cont.I$<span class="number">0</span> = localInt + result</span><br><span class="line">        cont.label = <span class="number">2</span></span><br><span class="line">        <span class="keyword">val</span> res = fun3(cont)</span><br><span class="line">        <span class="keyword">if</span> (res === COROUTINE_SUSPENDED) <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">        result = res</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fun3 执行完毕后的逻辑，无论同步异步都会走到这</span></span><br><span class="line">    <span class="keyword">val</span> localInt = cont.I$<span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> finalResult = localInt + result</span><br><span class="line">    <span class="keyword">return</span> finalResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改写后的代码逻辑清晰多了，我们来分析一下 fun1 中的逻辑：</p>
<ul>
<li><p>首先需要为 <code>fun1()</code>​ 构造对应的 <code>Continuation</code>​，如果传入的 <code>Continuation</code>​ 对象是 <code>Fun1Continuation</code>​ 类型，说明已经包装过了，就不做处理，否则，使用 <code>Fun1Continuation</code>​ 对 <code>continuation</code>​ 进行包装，将其作为上游 <code>Continuation</code>​ 持有。最后得到的 <code>cont</code>​ 便是 <code>fun1()</code>​ 所对应的 <code>Continuation</code>​。前面说过了，<code>Continuation</code>​ 中包含了函数的上下文，从这里能看出，这个上下文包含以下几个部分：</p>
<ul>
<li><p>执行进度，即 <code>cont.label</code>​；</p>
</li>
<li><p>上游 <code>suspend</code>​ 方法的 <code>Continuation</code>​ 对象；</p>
</li>
<li><p>局部变量，即 <code>cont.I$0</code>​，对应示例中的 <code>localInt</code>​；</p>
</li>
<li><p>最近一次调用 suspend 方法的结果，即 <code>cont.result</code>​；</p>
</li>
</ul>
</li>
</ul>
<p>接着往下看，有三个分支。</p>
<p>首先是  <code>0-&gt;</code>​ 分支，<code>fun1()</code>​ 首次调用时会进入这个分支。这个分支做了以下几件事：</p>
<ul>
<li>将 <code>label</code>​ 置为 1，将 <code>fun1()</code>​ 执行进度往下推进，下次调用时就会从 <code>1-&gt;</code>​ 这个分支执行。</li>
<li>调用 <code>fun2()</code>​ 获取其结果，如果结果为 <code>COROUTINE_SUSPENDED</code>​ ，说明 <code>fun2()</code>​ 挂起，<code>fun1()</code>​ 也返回<code>COROUTINE_SUSPENDED，</code>​表示自己因为 <code>fun2()</code>​ 的挂起而挂起。然而实际上<code>fun2()</code>​ 是一个披着 suspend 外衣的普通方法，kotlin 并不会将它当做 suspend 方法看待，这个方法编译后是一个普通的同步方法，所以此处 <code>fun2()</code>​ 返回的是 1，<code>fun1()</code>​ 会跳转到 61 行继续执行。</li>
<li>将 <code>fun2()</code>​ 返回值累加到 <code>localInt</code>​ 上；</li>
<li>将 <code>label</code>​ 置为 <code>2</code>​，将 <code>fun1()</code>​ 执行往下推进。下次执行时就会从 <code>2-&gt;</code>​ 这个分支执行。由此可见，<code>1-&gt;</code>​ 分支实际上并不会被执行，这是 <code>fun2()</code>​ 为同步函数造成的；</li>
<li>调用 <code>fun3()</code>​ ，<code>fun3()</code>​ 是一个 suspend 方法，它会返回 <code>COROUTINE_SUSPENDED</code>​，故<code>fun1()</code>​ 会从第  65 行返回，<code>fun1()</code>​ 的执行告一段落。</li>
</ul>
<p>​<code>fun1()</code>​ 此次调用结束后返回 suspend lambda 的第 8 行处：<code>fun1Result = fun1(this as Continuation)</code>​，前面我们说 <code>fun1()</code>​ 返回的是 <code>COROUTINE_SUSPENDED</code>​，这个结论在此处得到了印证。</p>
<p>接下来我们分析 <code>fun3()</code>​，<code>fun3()</code>​ 的反编译代码我就不放了，我们直接看用 kotlin 改写后的简化版：</p>
<h3 id="fun3"><a href="#fun3" class="headerlink" title="fun3"></a>fun3</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Fun3Continuation</span>(</span><br><span class="line">    <span class="keyword">val</span> completion: Continuation&lt;Any?&gt;</span><br><span class="line">) : ContinuationImpl&lt;Any?&gt;(completion) &#123;</span><br><span class="line">    <span class="keyword">var</span> label = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> result: Any? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> context = completion.context</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.result = result.getOrNull()</span><br><span class="line">		<span class="keyword">this</span>.label = <span class="keyword">this</span>.label or <span class="number">0x80000000</span></span><br><span class="line">		<span class="keyword">return</span> fun3(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fun3</span><span class="params">(continuation: <span class="type">Continuation</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any? &#123;</span><br><span class="line">    <span class="keyword">val</span> cont = <span class="keyword">if</span> (continuation <span class="keyword">is</span> Fun3Continuation) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((continuation.label and <span class="number">0x80000000</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            continuation.label = continuation.label and <span class="number">0x7fffffff</span></span><br><span class="line">            continuation</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Fun3Continuation(continuation)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Fun3Continuation(continuation)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = cont.result</span><br><span class="line"></span><br><span class="line">	<span class="keyword">when</span> (cont.label) &#123;</span><br><span class="line">        <span class="number">0</span> -&gt; &#123;</span><br><span class="line">            Result.throwOnFailure(result)</span><br><span class="line">            cont.label = <span class="number">1</span></span><br><span class="line">            <span class="keyword">val</span> res = delay(<span class="number">1000L</span>, cont)</span><br><span class="line">            <span class="keyword">if</span> (res === COROUTINE_SUSPENDED) <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="number">1</span> -&gt; &#123;</span><br><span class="line">            Result.throwOnFailure(result)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑和 <code>fun1()</code>​ 是大同小异的，前面的就不赘述了，进入到 <code>0-&gt; </code>​分支后，调用了 <code>delay()</code>​ 方法，这是 kotlin 提供的延时函数，它也是一个 suspend 方法，因此它会返回 <code>COROUTINE_SUSPENDED</code>​给 <code>fun1()</code>​，这和前面的分析是一致的。</p>
<p>继续深入下去会发现，<code>delay()</code>​ 会将一个延时任务插入到事件循环中，<code>1000ms</code>​ 延时后延时任务会调用 <code>Fun3Continuation</code>​ 的 <code>resumeWith()</code>​ 方法，这个方法会调到第 9 行的 <code>invokeSuspend()</code>​ 方法，<code>fun3()</code>​ 会再次执行。再次执行时，<code>cont.label </code>​的值为 <code>1</code>​，进入 <code>1-&gt;</code>​ 分支，检查无异常后代码走到 45 行返回 <code>1</code>​，<code>fun3()</code>​ 执行完毕。</p>
<p>​<code>fun3</code>​ 执行完成后，<code>Fun3Continuation</code>​会用 <code>fun3</code>​ 的执行结果 <code>1</code>​ 作为参数调用其 <code>completion</code>​ 也就是 <code>Fun1Continuation</code>​ 的 <code>resumeWith()</code>​ 方法，这个方法会调到第 8 行的 <code>invokeSuspend()</code>​ 方法，这会导致 <code>fun1()</code>​ 再次执行，再次执行时 <code>cont.label</code>​ 的值为 <code>2</code>​，会走到 <code>2-&gt;</code>​ 分支，检查无异常后代码走到第 69 行，将 <code>fun3()</code>​ 的执行结果 <code>1</code>​ 累加到 <code>localInt</code>​ 后将其作为最终结果返回，<code>fun1()</code>​ 执行完毕。</p>
<p>​<code>fun1()</code>​ 执行完成后，<code>Fun1Continuation</code>​会用 <code>fun1</code>​ 的执行结果 <code>localInt</code>​ 作为参数调用其 <code>completion</code>​也就是 <code>_SuspendLambda</code>​ 的 <code>resumeWith()</code>​ 方法，这个方法会调到第 5 行的 <code>invokeSuspend()</code>​ 方法，会导致 suspend lambda 再次执行，再次执行时  <code>label</code>​ 值为 <code>1</code>​， 会走到 <code>1 -&gt;</code>​分支处，检查无异常后代码走到第 26 行，将 <code>fun1()</code>​ 的执行结果 <code>localInt</code>​ 打印出来，suspend lambda 执行完毕。</p>
<h2 id="BlockingCoroutine"><a href="#BlockingCoroutine" class="headerlink" title="BlockingCoroutine"></a>BlockingCoroutine</h2><p>suspend 方法结束后，它的上游 suspend 方法的 <code>Continuation</code>​ 的 <code>resumeWith()</code>​ 都会被调用，那么当顶层的 suspend lambda 结束后呢？答案是 <code>BlockingCoroutine</code>​ 的 <code>resumeWith()</code>​ 会被调用。虽然 suspend lambda 没有上游 suspend 方法，但是它有上游  <code>Continuation</code>​，从前面的源码可知，<code>BlockingCoroutine</code>​ 就是这个上游 <code>Continuation</code>​，它是 <code>_SuspendLambda#create()</code>​调用时传进去的。<code>BlockingCoroutine</code>​ 定义如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">BlockingCoroutine</span>&lt;<span class="type">T</span>&gt;(</span><br><span class="line">    parentContext: CoroutineContext,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> blockedThread: Thread,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> eventLoop: EventLoop?</span><br><span class="line">) : AbstractCoroutine&lt;T&gt;(parentContext, <span class="literal">true</span>, <span class="literal">true</span>) &#123; </span><br><span class="line">    ...... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它继承自 <code>AbstractCoroutine</code>​：</p>
<h3 id="AbstractCoroutine"><a href="#AbstractCoroutine" class="headerlink" title="AbstractCoroutine"></a>AbstractCoroutine</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractCoroutine</span>&lt;<span class="type">in T</span>&gt;(</span><br><span class="line">    parentContext: CoroutineContext,</span><br><span class="line">    initParentJob: <span class="built_in">Boolean</span>,</span><br><span class="line">    active: <span class="built_in">Boolean</span></span><br><span class="line">) : JobSupport(active), Job, Continuation&lt;T&gt;, CoroutineScope &#123;</span><br><span class="line"></span><br><span class="line">   ……</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCompleted</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCancelled</span><span class="params">(cause: <span class="type">Throwable</span>, handled: <span class="type">Boolean</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">   ……</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Completes execution of this with coroutine with the specified result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> state = makeCompletingOnce(result.toState())</span><br><span class="line">        <span class="keyword">if</span> (state === COMPLETING_WAITING_CHILDREN) <span class="keyword">return</span></span><br><span class="line">        afterResume(state)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterResume</span><span class="params">(state: <span class="type">Any</span>?)</span></span>: <span class="built_in">Unit</span> = afterCompletion(state)</span><br><span class="line"></span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>AbstractCoroutine#resumeWith</code>​最终会调到<code>JobSupport#afterCompletion()</code>​，它在 <code>BlockingCoroutine</code>​有实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">BlockingCoroutine</span>&lt;<span class="type">T</span>&gt;(</span><br><span class="line">    parentContext: CoroutineContext,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> blockedThread: Thread,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> eventLoop: EventLoop?</span><br><span class="line">) : AbstractCoroutine&lt;T&gt;(parentContext, <span class="literal">true</span>, <span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> isScopedCoroutine: <span class="built_in">Boolean</span> <span class="keyword">get</span>() = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterCompletion</span><span class="params">(state: <span class="type">Any</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// wake up blocked thread</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != blockedThread)</span><br><span class="line">            unpark(blockedThread)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">joinBlocking</span><span class="params">()</span></span>: T &#123;</span><br><span class="line">        registerTimeLoopThread()</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            eventLoop?.incrementUseCount()</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="meta">@Suppress(<span class="string">&quot;DEPRECATION&quot;</span>)</span></span><br><span class="line">                    <span class="keyword">if</span> (Thread.interrupted()) <span class="keyword">throw</span> InterruptedException().also &#123; cancelCoroutine(it) &#125;</span><br><span class="line">                    <span class="keyword">val</span> parkNanos = eventLoop?.processNextEvent() ?: <span class="built_in">Long</span>.MAX_VALUE</span><br><span class="line">                    <span class="comment">// note: process next even may loose unpark flag, so check if completed before parking</span></span><br><span class="line">                    <span class="keyword">if</span> (isCompleted) <span class="keyword">break</span></span><br><span class="line">                    parkNanos(<span class="keyword">this</span>, parkNanos)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123; <span class="comment">// paranoia</span></span><br><span class="line">                eventLoop?.decrementUseCount()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123; <span class="comment">// paranoia</span></span><br><span class="line">            unregisterTimeLoopThread()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// now return result</span></span><br><span class="line">        <span class="keyword">val</span> state = <span class="keyword">this</span>.state.unboxState()</span><br><span class="line">        (state <span class="keyword">as</span>? CompletedExceptionally)?.let &#123; <span class="keyword">throw</span> it.cause &#125;</span><br><span class="line">        <span class="keyword">return</span> state <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>afterCompletion</code>​会将 <code>runBlocking()</code>​ 的调用者线程唤醒，这通常发生在 <code>runBlocking()</code>​调用线程和协程运行线程不相同的情况下，例如我们调用 <code>runBlocking()</code>​ 的时候，指定了 <code>Dispatcher</code>​:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runBlocking(Dispatchers.IO, &#123;</span><br><span class="line">	……</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这会导致 24 行的 <code>eventLoop</code>​ 为 <code>null</code>​，从而让调用者线程走到 27 行进行无限时长的休眠，以达到阻塞调用者线程的目的。这种情况下就需要协程结束后，主动解除调用者线程的休眠，从而继续执行后面的代码。</p>
<p>否则，如果没有指定 <code>Dispatcher</code>​，调用者线程会因为运行 <code>eventLoop</code>​ 自行阻塞，等协程结束后，<code>eventLoop</code>​ 会在 26 行退出，因此不需要其他线程来唤醒调用者线程。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>每一个 <code>suspend</code>​ 方法都和一个 <code>Continuation</code>​ 对象关联着；（<code>fun2()</code>​ 这种并没有真正 <code>suspend</code>​ 的方法除外）</li>
<li>当一个方法返回 <code>COROUTINE_SUSPENDED</code>​ 时，其实就是就是告诉调用者自己将会挂起（暂停），这个返回值会导致 suspend 调用栈中止，调用栈上游的所有方法也都被挂起；</li>
<li>下游 suspend 方法恢复时，会通过调用上游 suspend 方法所关联的 <code>Continuation</code>​ 对象的 <code>resumeWith()</code>​ 方法，触发上游方法的恢复。</li>
</ul>
<p>最后画一张图帮助理解：</p>
<p><img src="/img/in-post/post_kotlin_coroutine_state_machine/kotlin_coroutine.svg" alt="Kotlin 协程"></p>
<p> Kotlin 协程中的所谓状态机，其实就是 Kotlin 为 <code>suspend</code>​ 方法生成的 <code>Continuation</code>​ 对象，<code>Continuation</code>​ 负责存储状态，方法如何执行由 <code>Continuation</code>​ 中的状态决定。</p>
<p>​<code>Contiuation</code>​ 在无栈协程中充当了栈帧（上下文）的作用：</p>
<ul>
<li>保存了局部变量，即 <code>Continuation</code>​ 中的 <code>I$0</code>​ 字段；</li>
<li>保存了方法中断后的返回地址，即 <code>label</code>​；</li>
<li>每一个 <code>Continuation</code>​ 通过 <code>completion</code>​ 字段引用上游方法的 <code>Continuation</code>​，构成了 <code>Continuation</code>​ 链，这构成了 <code>suspend</code>​ 方法专属的 ”调用栈“。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2024/04/04/2024-04-04-understand-cross-origin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/04/2024-04-04-understand-cross-origin/" class="post-title-link" itemprop="url">理解前端跨源问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-04 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-04T00:00:00+00:00">2024-04-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是跨源请求？"><a href="#什么是跨源请求？" class="headerlink" title="什么是跨源请求？"></a>什么是跨源请求？</h1><p>先看看什么是同源 URL：</p>
<blockquote>
<p>如果两个 URL 的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Protocol">协议</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Port">端口</a>（如果有指定的话）和<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Host">主机</a>都相同的话，则这两个 URL 是同源的。这个方案也被称为“协议&#x2F;主机&#x2F;端口元组”，或者直接是“元组”。（“元组”是指一组项目构成的整体，具有双重&#x2F;三重&#x2F;四重&#x2F;五重等通用形式。）</p>
</blockquote>
<p>当网站的 URL 和网站发出请求的 URL 是非同源的，我们便说这个请求是跨源请求。</p>
<h1 id="请求为什么不能跨源？"><a href="#请求为什么不能跨源？" class="headerlink" title="请求为什么不能跨源？"></a>请求为什么不能跨源？</h1><p>假如 A 是银行网站，你在 A 网站上进行了登录，A 网站将 token 保存在浏览器的 cookies 中。接下来你收到了一封钓鱼网站 B 发来的邮件，并点开了其中的连接，然后 B 网站在你不知情的情况下调用 A 网站的转账接口，将你在这家银行的钱全转进他的帐户里。由于转账接口的域名是 A 网站的，因此这个请求会把浏览器保存的 A 网站 cookies 也一并带上去，于是该请求就能顺利通过 A 网站服务器的身份验证，然后你💰就没了 : (。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/04/04/2024-04-04-understand-cross-origin/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2024/03/29/2024-03-29-install-openwrt-with-openclash-on-raspi-3bplus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/29/2024-03-29-install-openwrt-with-openclash-on-raspi-3bplus/" class="post-title-link" itemprop="url">树莓派 3B+ 刷 OpenWrt 并安装 OpenClash</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-29 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-29T00:00:00+00:00">2024-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div class='img-no-shadow'>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>心血来潮打开了尘封已久的 switch，发现软件更新实在太慢，上网找了几种常用的加速方法，各有优劣，但最终都被 pass：</p>
<ul>
<li>更改 DNS 服务器，缺点是网速提升有限，大概在 34 Mbps 左右，大概提升 1 ~ 2 Mbps 左右 ，相对 switch 几百 M 几个 G 的游戏来说，依然是龟速。唯一的好处是不用借助其他设备。</li>
<li>买加速器。对于喜欢折腾的人来说，花钱永远是最后的选择，况且我自己有梯子，干嘛花这个冤枉钱。</li>
<li>把电脑上的代理通过局域网分享给 switch，然而发现网速的提升依然不高，虽然后来发现是 USB 无线网卡的问题，但不管怎样，电脑一直保持开机状态，就是为了给 swtich 做代理，总感觉不太优雅。</li>
</ul>
<p>我心想要是能在路由器上跑代理就好了，不过现在的路由器不支持装插件，而且是公用的，不太适合去折腾。这时候突然想起了我还有个同样在吃灰的树莓派，如果能把这台树莓派变成一台软路由，再在这个软路由上跑代理，岂不美哉？于是上网搜索 “如何在树莓派上装软路由”，不出所料，搜出了一堆教程。一番学习后，最后选择了 OpenWrt 这款软路由固件，一是因为它插件比较多，有更多可玩性，二是用户量大，教程多，遇到问题容易找到解决方案。</p>
<p>话不多说，开干。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/03/29/2024-03-29-install-openwrt-with-openclash-on-raspi-3bplus/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2023/09/29/2023-09-29-reading-notes-%209787121085116-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/29/2023-09-29-reading-notes-%209787121085116-1/" class="post-title-link" itemprop="url">《程序员的自我修养》读书笔记一</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-29 00:00:00" itemprop="dateCreated datePublished" datetime="2023-09-29T00:00:00+00:00">2023-09-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>P199： “默认情况下，如果可执行文件是动态连接的，那么 GCC 会使用 PIC 的方法来产生可执行文件的代码段部分，以便于不同的进程能够共享” 但我用 GCC 去编译 32 位可执行文件，加 <code>-fPIC</code> 和不加 <code>-fPIC</code>，编出的指令是有差别的：</p>
<p><img src="/img/in-post/reading-notes-9787121085116-1/fpic.png" alt="-fPIC 对生成指令的影响"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/29/2023-09-29-reading-notes-%209787121085116-1/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2023/09/16/2023-09-16-play-with-vfork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/16/2023-09-16-play-with-vfork/" class="post-title-link" itemprop="url">vfork 的诡异输出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-16 00:00:00" itemprop="dateCreated datePublished" datetime="2023-09-16T00:00:00+00:00">2023-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>学习 vfork 的时候，看到<a target="_blank" rel="noopener" href="https://blog.csdn.net/kxcfzyk/article/details/41411099">这篇文章</a>中的一个例子，觉得很有趣，就拷贝下来自己跑了一下，其中的例子差不多是这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">fun1</span><span class="params">()</span> &#123;</span><br><span class="line">    vfork();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, getpid());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">fun2</span><span class="params">()</span> &#123;</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">    fun1();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d goes 1\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    fun2();   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d goes 2\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/16/2023-09-16-play-with-vfork/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2022/11/04/2022-11-04-CM201-crack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/04/2022-11-04-CM201-crack/" class="post-title-link" itemprop="url">移动魔百盒 CM201 CH(长虹代工) 破解方法分享</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-04 00:00:00" itemprop="dateCreated datePublished" datetime="2022-11-04T00:00:00+00:00">2022-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这两天为了破解到期魔百盒看了好多帖子，最终成功破解了。为了让大家少走弯路，只看一篇帖子就能完成破解，我汇总了一下这两天学习到的东西，并分享下我的破解经历，希望对大家有所帮助。</p>
<h1 id="盒子型号"><a href="#盒子型号" class="headerlink" title="盒子型号"></a>盒子型号</h1><p>首先说下盒子型号是 CM201-2 长虹代工 (CH)，具体信息见图片：</p>
<p><img src="/img/in-post/cm201_crack/box-info.jpg" alt="盒子信息"></p>
<p>板子上的硬件信息是：CPU 型号是 HI3890MV300，闪存是 emmc。机型编码和牌照方不同应该没太大关系，因为网上那些教程和我的都不一样，但我也刷机成功了。大家可以先尝试一下，如果不行再说。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/11/04/2022-11-04-CM201-crack/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2018/04/06/2018-04-06-android-focus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/06/2018-04-06-android-focus/" class="post-title-link" itemprop="url">View 的焦点机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-06 00:00:00" itemprop="dateCreated datePublished" datetime="2018-04-06T00:00:00+00:00">2018-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="View-的焦点机制"><a href="#View-的焦点机制" class="headerlink" title="View 的焦点机制"></a>View 的焦点机制</h1><p><strong>约定：文章中的 View 有时是指狭义的 View.class，有时指的是 View.class 和 ViewGruop.class 的统称，具体含义根据上下文而定</strong>。</p>
<h2 id="和焦点相关的-xml-属性"><a href="#和焦点相关的-xml-属性" class="headerlink" title="和焦点相关的 xml 属性"></a>和焦点相关的 xml 属性</h2><p>在 xml 中，有两个比较重要的属性和焦点有关，它们是 focusable 和 focusableInTouchMode。前者决定这个 View 是否可获取焦点，如果它的值为 false，那么它就和焦点无缘了；后者决定这个 View 在触屏模式下是否可获取焦点，如果它的值为 false，那么即使 focusable 的值为 true，在触屏模式下它也无法获取焦点。比如 Button，如果我们通过外接键盘进行操作，我们会发现 Button 是可以获得焦点的，但是在触屏模式下，Button 是不可获取焦点的。所以我们可以知道 Button 的 focusable 属性默认为 true，而 focusableInTouchMode 属性为 false。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/04/06/2018-04-06-android-focus/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2017/11/07/2017-11-07-android-launch-mode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/07/2017-11-07-android-launch-mode/" class="post-title-link" itemprop="url">Android LaunchMode 总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-07 00:00:00" itemprop="dateCreated datePublished" datetime="2017-11-07T00:00:00+00:00">2017-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Android-LaunchMode-总结"><a href="#Android-LaunchMode-总结" class="headerlink" title="Android LaunchMode 总结"></a>Android LaunchMode 总结</h1><p>Android 中的 LaunchMode 是一个比较基础的知识点，关于这块之前每次都是先用现学，然后学了之后又忘了，现在把 LaunchMode 的规律记录下来以备后用。</p>
<h2 id="需要了解的知识点"><a href="#需要了解的知识点" class="headerlink" title="需要了解的知识点"></a>需要了解的知识点</h2><p>在讲 LaunchMode 之前，需要了解一下几点知识：</p>
<ol>
<li>task 有属性 affinity，Activity 有属性 taskAffinity</li>
<li>可以存在两个 affinity 一样的 task；</li>
<li>一个 Activity 的 taskAffnity 默认值为 package name，如果有指定值就会设为指定值
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/11/07/2017-11-07-android-launch-mode/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2017/09/05/2017-09-05-android-how-motion-event-dispatched/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/05/2017-09-05-android-how-motion-event-dispatched/" class="post-title-link" itemprop="url">Android 事件分发规律总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-09-05 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-05T00:00:00+00:00">2017-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Android-事件分发规律总结"><a href="#Android-事件分发规律总结" class="headerlink" title="Android 事件分发规律总结"></a>Android 事件分发规律总结</h1><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>事件序列：手指接触屏幕开始到离开屏幕为止产生的事件为一次事件序列。</p>
<h2 id="规律一"><a href="#规律一" class="headerlink" title="规律一"></a>规律一</h2><p>从父视图的角度来看，无论他的子视图是 View 还是 ViewGroup，对父视图来说都是透明的。它只知道如果当 ACTION_DOWN 事件传给子视图后子视图的 dispatchTouchEvent () 返回 true，说明子视图想要处理这个事件，那么以后的事件就都交给它，不管以后子视图的 dispatchTouchEvent() 返回的是 true 还是 false; 如果 ACTION_DOWN 事件传给子视图后子视图返回的是 false，那么以后的事件再也不会传给子视图（子视图没有处理 ACTION_DOWN 就视作它不想处理该事件序列）。如果一个子视图的 dispatchTouchEvent() 在处理 ACTION_DOWN 时返回 true ，只要父视图没有拦截事件, 那么该事件序列中的后续事件都会传入该视图中，也就是传入该视图的 dispatchTouchEvent() 方法中，就算手指的触摸区域已经超出了该视图的范围。并且对于该事件序列的之后所有事件，即使该视图的 dispatchTouchEvent() 返回 false 事件也同样会继续传入该视图，唯一的影响是会将该事件原路返回，最终落到 activity.onTouchEvent() 中。因此建议如果消耗了该事件，除非有特殊情况需要处理，最好不要返回 false，否则上级视图以为下面的视图没有处理事件从而自己处理。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/09/05/2017-09-05-android-how-motion-event-dispatched/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lwenkun.github.io/2017/08/29/2017-08-29-how-an-android-process-starts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/29/2017-08-29-how-an-android-process-starts/" class="post-title-link" itemprop="url">Android 进程启动原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-29 00:00:00" itemprop="dateCreated datePublished" datetime="2017-08-29T00:00:00+00:00">2017-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-30 01:07:18" itemprop="dateModified" datetime="2025-06-30T01:07:18+00:00">2025-06-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Android-进程启动原理"><a href="#Android-进程启动原理" class="headerlink" title="Android 进程启动原理"></a>Android 进程启动原理</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Android 中的应用是支持多进程的，我们只要在 AndroidManifest 中给四大组件指定 android:process 属性即可让其运行在独立的进程当中。那么应用的主进程又是如何被创建的呢？一般来说，当我们的应用没有任何组件处于运行状态，此时其他应用启动我们应用的组件时，应用的主进程就会被创建，进程相当于是提供了组件运行的空间。最常见的触发应用主进程被创建的方式是应用 A 通过 startActivity 或者 startActivityForResult 启动应用 B，并且应用 B 此时没有任何组件处于运行状态，那么系统先会通过 AMS 为 B 创建一个进程，等进程创建好了再通知应用 B 创建并运行该 Activity。AMS 是运行在 system_server 进程当中的，这个进程并不会 fork 出应用进程，那么应用进程到底是哪个进程创建的呢？这就得从 Zygote 进程说起。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/08/29/2017-08-29-how-an-android-process-starts/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chance"
      src="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
  <p class="site-author-name" itemprop="name">Chance</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Lwenkun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Lwenkun" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chance@liwenkun.me" title="E-Mail → mailto:chance@liwenkun.me" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://ylqhust.github.io/" title="http:&#x2F;&#x2F;ylqhust.github.io" rel="noopener" target="_blank">ylqhust的博客</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chance</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">256k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">3:53</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
